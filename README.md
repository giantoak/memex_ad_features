# memex_ad_features
The purpose of this repository is to calculate a number of economic metrics on MEMEX `escorts` data. It's a small data pipeline intended to take a number of extractions from scraped advertisements and spit out usable JSON data.

## Design
The different data targets are managed by the [`Makefile`.](https://github.com/giantoak/memex_ad_features/blob/master/Makefile) Input data for a given target is passed through a number of Python and R scripts, and a generated CSV is spat out.

### Input
**Currently**, the Makefile takes as input TSV-file dumps of Lattice data stored in S3 buckets, and the tsv files dumped by the different files. **Eventually** the makefile will replace these S3 dumps Lattice files stored in HDFS. Potentially, it will also take other extractions from the different teams as well.

### Output
**Currently**, the Makefile spits out a number of different CSV files. **Eventually** it will dump these files into HDFS for general consumption.

### Target Dependencies
The below dependency graph is intended to provide an overview of the makefile and chain of targets that it can create. If it doesn't render correctly, know that all is well! Just click on the "missing" icon to get to the file itself.

![Markdown Target Dependencies](https://github.com/giantoak/memex_ad_features/blob/master/makefile_graph.svg "Makefile sources and targets")

## Target Plans
We will be pairing down this version of the makefile to focus on a limited number of targets. Specifically:

* Ad-level metrics
Note that most ad-level metrics are relatively unimportant. User facing systems already have basic ad information and extracted information. So the theme of what we're going to contribute here is either we're going to impute price for ads or we're going to contribute measures which depend in part on aggregated statistics such as 
  * Non-imputed features
    * [ ] Ad price at ad level (`price_per_hour` in `make_ad_prices.py`)
    * [ ] Price relative to city average (`price_per_hour` - `ad_mean_msa`)/`ad_std_msa`
    * [ ] Price quantile in city (i.e. is this ad at the 25th percentile?  30th perentile?)
    * [ ] Price relative to phone number level average
    * [ ] Flag difference from MSA average. I.e. if 30% of ads in an MSA are flagged "Juvenile", MSA average is .3, so a non-"Juvenile" flagged ad will have a value of -0.3 and a "Juvenile" flagged at 0.7
  * Imputations
    * [ ] Price if missing
    * [ ] Age if missing
* City/MSA-level metrics
  * Those laid out in `msa_characteristics.csv` (generated by [`make_msa_characteristics.py`](https://github.com/giantoak/memex_ad_features/blob/2593f8a89ff70b57bba8dd4c4260c7b3df648e63/make_msa_characteristics.py))
    * [ ] `ad_count_msa` - number of ads
    * Lattice-extracted Price data per MSA
      * [ ] `ad_mean_msa` - Mean
      * [ ] `ad_std_msa` - Standard deviation of price within MSA
      * [ ] `ad_p<X>_msa`, where `<X> = range(0, 100, 5)` - value at the Xth price percentile
    * Lattice flag data per MSA
      * [ ] `ad_incall_msa` - percent of ads with incall by MSA
      * [ ] `ad_outcall_msa` - percent of ads with outcall by MSA
      * [ ] `ad_<ethnicity>_msa` - percent of ads with given `<ethnicity>` (each ethnicity will have its own column)
        * [ ] (various ethnicities)
      * [ ] `ad_<flag>_msa` - percent of ads with given `<flag>` (each flag will be its own column)
        * [ ] (various flags)
    * Lattice-extracted Age data per MSA
      * [ ] `ad_mean_age` - Mean
      * [ ] `ad_p<X>_age_msa` where `<X> = range(0, 100, 5)` - value at the the Xth age percentile
  
* Ad-level matrics
  * Those laid out in `ad_price_ad_level.csv` (generated by [`make_ad_prices.py`](https://github.com/giantoak/memex_ad_features/blob/master/make_ad_prices.py))
    * [ ] Average price price per hour (`price_per_hour` variable in data)
    * [ ] Is ad priced per hour? (`1hr` variable in data)
    * [ ] All others… (This needs breaking down, if it exists) 
  * [ ] Total number of extracted prices (possibly not included in data at this point, but good to have)
  
* Phone-level metrics

*No* metrics at this level are in the original makefile, but we have been moving in that direction. (See, for instance, [`make_phone_characteristics.py`](https://github.com/giantoak/memex_ad_features/blob/master/make_phone_characteristics.py) and [`make_phone_level.py`](https://github.com/giantoak/memex_ad_features/blob/master/make_phone_level.py).) These metrics come from [Steve Bach's computations](https://github.com/HazyResearch/memex-analysis)

  * [ ] All values in `data/bach/phones.csv`. (Not in repo)
    * [ ] `n_ads` - Number of ads posted by this phone number in sample
    * [ ] `n_distinct_locations` - Number of unique cities
    * [ ] `location_tree_length` - a measure of how far apart the phone number appears around the US
    * [ ] `n_incall` - Number of ads posted by this phone number that are incalls.
    * [ ] `n_outcall` - Number of ads posted by this phone number that are outcalls.
    * [ ] Other metrics… (needs to be broken down)
  * [ ] All values in `data/bach/phones_by_month.csv`. (Not in repo)
    * [ ] `n_ads` - Number of ads posted by this phone number in sample
    * [ ] `n_distinct_locations` - Number of unique cities
    * [ ] `location_tree_length` - a measure of how far apart the phone number appears around the US
    * [ ] `n_incall` - Number of ads posted by this phone number that are incalls.
    * [ ] `n_outcall` - Number of ads posted by this phone number that are outcalls.
    * [ ] Other metrics… (needs to be broken dow)

## Future Possibilities

* MSA-level values, cross-tabbed by gender using ACS data
